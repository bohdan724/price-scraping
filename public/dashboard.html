<!DOCTYPE html>
<html lang="en">
    <head>
        <!-- Bootstrap CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <!-- Bootstrap Icons -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
        <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
        <style>
            body {
                padding: 20px;
            }
            .btn {
                margin-right: 10px;
            }
            .modal-body input {
                width: 100%;
            }
            .table th, .table td {
                vertical-align: middle;
            }
            .mb-4 {
                margin-top: 70px;
            }
            hr {
                border-top: 2px solid #000; /* Example: Bootstrap blue */
                opacity: 1;
            }
            textarea {
                height: 100px;
                border: 1px solid #000 !important;
            }
        </style>
    </head>
    <body>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#customerModal">Create Customer</button>
        <label class="btn btn-primary mb-0">
            Select xlsx File
            <input type="file" id="xlsxFileInput" accept=".xlsx" style="display:none" onchange="handleXlsxUpload(event)">
        </label>
        <button class="btn btn-danger" onclick="dataInitial()" style="position: fixed; left: 50%; transform: translateX(-50%);">Initial Data</button>
        <button class="btn btn-primary" onclick="downloadExcel()" style="float: right;">Download</button>
        <div id="dashboard"></div>
        <!-- Bootstrap Modal -->
        <div class="modal fade" id="customerModal" tabindex="-1" aria-labelledby="customerModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="customerModalLabel">Create Customer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <input id="customerName" class="form-control"></input>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveCustomerFromModal()" data-bs-dismiss="modal">Save</button>
              </div>
            </div>
          </div>
        </div>
        <!-- Bootstrap JS Bundle -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            function dataInitial() {
                if (!confirm("This will delete all existing data and load initial data. Do you want to continue?")) {
                    return;
                }
                fetch('/initial', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                })
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                })
            }

            var customers = [];
            var customerId = 1;
            var dashboard = document.getElementById('dashboard');
            function saveCustomerFromModal() {
                var customerName = document.getElementById('customerName').value;
                if (!customerName) {
                    alert('Please enter a customer name.');
                    return;
                }
                customers.push({ id: customerId, name: customerName, products: [] });
                saveCustomerTable({ id: customerId, name: customerName, products: [] });
                customerId++;
            }

            function handleXlsxUpload(e) {
                const file = e.target.files[0];
                const reader = new FileReader();

                reader.onload = function (event) {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        workbook.SheetNames.forEach(sheetName => {
                        const sheet = workbook.Sheets[sheetName];
                        if (sheetName == "Extra Data") {
                            const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                            var data = JSON.parse(JSON.stringify(rows, null, 2))
                            const result = [];
                            let currentGroup = [];
                            for (const row of data) {
                                const isEmptyRow = row.every(cell => cell === '');
                                if (isEmptyRow) {
                                if (currentGroup.length > 0) {
                                    result.push(currentGroup);
                                    currentGroup = [];
                                }
                                } else {
                                    currentGroup.push(row);
                                }
                            }
                            // Add the last group if not empty
                            if (currentGroup.length > 0) {
                                result.push(currentGroup);
                            }
                            result.forEach((group) => {
                                if (group.length > 2) {
                                    var customer = {id: customerId, name: group[0][0], products: [], low: 20, middle: 0.7, high: 0.75};
                                    for (var i = 1; i < group.length - 1; i++) {
                                        customer.products.push({
                                            title: group[i][0],
                                            brand: group[i][1],
                                            condition: group[i][2],
                                            price: {
                                                display: group[i][3],
                                                amount: parseFloat(group[i][3].replace(/[^0-9.-]+/g, ""))
                                            },
                                            url: group[i][4] || '#'
                                        });
                                    }
                                    saveCustomerTable(customer);
                                    customers.push(customer);
                                    customerId++;
                                }
                            })
                        }
                    });
                };
                reader.readAsArrayBuffer(file);
            }

            function saveCustomerTable(customer) {
                dashboard.innerHTML += `
                    <div id="customer${customer.id}" class="mb-4">
                        <h3>
                            <div class="d-flex align-items-center my-4">
                                <hr class="flex-grow-1 me-3">
                                <span style="font-weight: bold; color: #888; font-size: 1.1em; letter-spacing: 2px; white-space: nowrap; color: black;">
                                    ${customer.name} 
                                    <button type="button" class="btn btn-danger btn-sm" onclick="deleteCustomer(${customer.id})" title="Delete">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </span>
                                <hr class="flex-grow-1 ms-3">
                            </div>
                        </h3>
                        <textarea id="customerTextArea${customer.id}" class="form-control mb-2" placeholder="Please enter product name">Fender Vintage, Very good</textarea>
                        <div style="margin-top: 20px">
                            <button class="btn btn-success mb-2" onclick="saveProducts(${customer.id})">Calculate Prices</button>
                            <button class="btn btn-primary" onclick="refreshProducts(${customer.id})" style="float: right"><span class="glyphicon glyphicon-refresh"></span> Refresh</button>
                        </div>
                        <table id="customerTable${customer.id}" class="table table-bordered" style="margin-top: 10px">
                            <thead class="table-light">
                                <tr>
                                    <th>Title</th>
                                    <th>Brand</th>
                                    <th>Condition</th>
                                    <th>Price</th>
                                    <th>Adjusted Price</th>
                                    <th>Link</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="customerBody${customer.id}">
                                ${
                                    customer.products.map((item, i) => `
                                        ${addTBodyHtml(customer, item)}
                                    `).join('')
                                }
                            </tbody>
                        </table>
                    </div>
                `;
            }

            function deleteCustomer(customerId) {
                if (!confirm("Are you sure you want to delete this customer?")) {
                    return;
                }
                var customerDiv = document.getElementById(`customer${customerId}`);
                if (customerDiv) {
                    dashboard.removeChild(customerDiv);
                }
                customers = customers.filter(c => c.id !== customerId);
            }

            var deletedRows = [];

            function deleteTableRows(customerId, rowId) {
                var button = document.querySelector(`button[data-row="${rowId}"]`);
                var customerBody = document.getElementById(`customerBody${customerId}`);
                var row = button.closest('tr');
                customerBody.removeChild(row);
                deletedRows.push(rowId);
                var customer = customers.find(c => c.id === customerId);
                if (customer) {
                    customer.products = customer.products.filter((_item, index) => _item.id != rowId.replace(`customer${customerId}delete`, ''));
                }
            }

            function saveProducts(customerId) {
                var textArea = document.getElementById(`customerTextArea${customerId}`);
                var text = textArea.value;
                if (!text) {
                    alert('Please enter product details.');
                    return;
                }
                const lines = text
                    .split(/\n|\r/)
                    .map((l) => l.trim())
                    .filter(Boolean);
                var pedals = [];
                for (let line of lines) {
                    const [name, condition] = line.split(",").map((s) => s && s.trim());
                    if (name)
                        pedals.push({ name, condition: condition || "Excellent" });
                }
                getProducts(customerId, pedals)
                // Make API request to backend
            }

            function getProducts(customerId, pedals) {
                fetch('/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ pedals: JSON.stringify(pedals) })
                })
                .then(response => response.json())
                .then(data => {
                    var customerBody = document.getElementById(`customerBody${customerId}`);
                    if (data && Array.isArray(data.products)) {
                        var customer = customers.find(c => c.id === customerId);
                        if (document.getElementById('noData') !== null) customerBody.removeChild(document.getElementById('noData'));
                        data.products.forEach((item, i) => {
                            customer.products.push({
                                id: item.id,
                                productId: item.productId || '',
                                title: item.title || '',
                                brand: item.title.split(" ")[0] || '',
                                condition: item.condition.display_name || '',
                                price: item.price,
                                displayPrice: item.price.display || '',
                                url: item.url ? item.url : '#'
                            });
                            customerBody.innerHTML += addTBodyHtml(customer, item);
                        });
                        var textArea = document.getElementById(`customerTextArea${customerId}`);
                        textArea.value = '';
                    } else {
                        customerBody.innerHTML = '<tr id="noData"><td colspan="6" class="text-center">No Data</td></tr>';
                    }
                })
                .catch((err) => {
                    console.log(err)
                    // var customerBody = document.getElementById(`customerBody${customerId}`);
                    // customerBody.innerHTML = '<tr><td colspan="6" class="text-center">No Data</td></tr>';
                });
            }

            function getAdjustPrice(customer, item) {
                var base = item.price.amount || 0;
                var adjusted = 0;
                if (base <= 69) {
                    adjusted = customer.low;
                } else if (base >= 70 && base <= 199) {
                    adjusted = Math.round(base * customer.middle);
                } else if (base >= 200) {
                    adjusted = Math.round(base * customer.high);
                }
                return adjusted;
            }

            function addTBodyHtml(customer, item) {
                return `
                    <tr>
                        <td>${item.title || ''}</td>
                        <td>${item.title.split(" ")[0] || ''}</td>
                        <td>${item.condition.display_name || ''}</td>
                        <td>${item.price.display || ''}</td>
                        <td>$${getAdjustPrice(customer, item)}</td>
                        <td><a href="${item.url ? item.url : '#'}" target="_blank">Link</a></td>
                        <td style="text-align: center">
                            <button type="button" data-row="customer${customer.id}delete${item.id}" class="btn btn-danger btn-sm" onclick="deleteTableRows(${customer.id}, 'customer${customer.id}delete${item.id}')" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `
            }
            function refreshProducts(customerId) {
                var customer = customers.find(c => c.id === customerId);
                if (customer && Array.isArray(customer.products) && customer.products.length > 0) {
                    let pedals = customer.products.map(product => ({ name: product.title, condition: product.condition }));
                    var customerBody = document.getElementById(`customerBody${customerId}`);
                    customerBody.innerHTML = "";
                    customer.products = [];
                    getProducts(customerId, pedals);
                }
            }


            function downloadExcel() {
                var sheets1 = [["Customer Name", "Total Price"]], sheets2 = [];
                customers.forEach((customer) => {
                    sheets2.push([customer.name, "Brand", "Condition", "Price", "Link"])
                    var totalPrice = 0;
                    customer.products.forEach((product) => {
                        sheets2.push([
                            product.title,
                            product.brand,
                            product.condition,
                            product.price.display || '$0',
                            getAdjustPrice(customer, product),
                            product.url
                        ]);
                        totalPrice += product.price.amount
                    });
                    sheets2.push(["", "", "", "Total Price", "$" + totalPrice]);
                    sheets2.push(["", "", "", "", ""]);
                    sheets1.push([customer.name, "$" + totalPrice]);
                })
                const sheet1 = XLSX.utils.aoa_to_sheet(sheets1);
                const sheet2 = XLSX.utils.aoa_to_sheet(sheets2);
                // Create workbook and add sheets
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, sheet1, "Customers");
                XLSX.utils.book_append_sheet(workbook, sheet2, "Extra Data");
                let now = new Date();
                let pad = (n) => n.toString().padStart(2, "0");
                let datetime = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(
                    now.getDate()
                )}_${pad(now.getHours())}-${pad(now.getMinutes())}-${pad(
                    now.getSeconds()
                )}`;
                XLSX.writeFile(workbook, "multi-sheet " + datetime + ".xlsx");
            }
        </script>
    </body>
</html>